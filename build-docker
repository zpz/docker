#!/bin/bash

set -Eeuo pipefail

UBUNTU_VERSION=22.04
PYTHON_VERSION=3.10
PYTHON_TAG=310
# ubuntu 20.04 default python 3.8, 22.04 3.10, 24.04 3.12.


TINY=zppz/tiny:25.08.30
TAG=$(docker run --rm ${TINY} make-date-version)
NAMESPACE=zppz
THISDIR=$(cd $( dirname "${BASH_SOURCE[0]}") && pwd )


function build-image {
    name="$1"
    shift
    build_dir="$1"
    shift
    echo
    echo "building $name ..."
    echo
    docker build -t "${name}" "${build_dir}" $@
    echo
}


function build-py3 {
    build-image ${NAMESPACE}/py${PYTHON_TAG}:${TAG} ${THISDIR}/py3 --build-arg PARENT=ubuntu:${UBUNTU_VERSION} --build-arg PYTHON_VERSION=${PYTHON_VERSION}
}


function build-py3-r {
    cmd="$(docker run --rm ${TINY} cat /usr/tools/find-image)"
    parent=$(bash -c "${cmd}" -- zppz/py${PYTHON_TAG})
    build-image ${NAMESPACE}/py${PYTHON_TAG}-r:${TAG} ${THISDIR}/py3-r --build-arg PARENT=${parent}
}


function build-py3-rust {
    cmd="$(docker run --rm ${TINY} cat /usr/tools/find-image)"
    parent=$(bash -c "${cmd}" -- zppz/py${PYTHON_TAG})
    build-image ${NAMESPACE}/py${PYTHON_TAG}-rust:${TAG} ${THISDIR}/py3-rust --build-arg PARENT=${parent}
}


if [[ $# == 0 ]]; then
    img=py3
elif [[ $# == 1 ]]; then
    img="$1"
else
    >&2 echo "too many arguments"
    exit 1
fi

if [ "${img}" = py3 ]; then
    build-py3
elif [ "${img}" = py3-r ]; then
    build-py3-r
elif [ "${img}" = py3-rust ]; then
    build-py3-rust
else
    >&2 echo "unknown image name '${img}'"
    exit 1
fi


# Use `docker push zppz/py310:xxxxxx` to push the image to Dockerhub.